name: CI

on:
  push:
    branches: ["*"]
    tags: ["v*"]
  pull_request:

jobs:
  # Build, smoke-test, and produce binaries for each platform
  build:
    name: Build (${{ matrix.arch }})
    runs-on: ${{ matrix.runs-on }}
    container: ${{ matrix.container || '' }}
    strategy:
      matrix:
        include:
          - arch: linux-x86_64
            runs-on: ubuntu-latest
            container: crystallang/crystal:latest-alpine
            build-flags: --static
          - arch: macos-arm64
            runs-on: macos-latest
            container: ""
            build-flags: ""
    steps:
      - uses: actions/checkout@v4

      - name: Install Crystal (macOS)
        if: matrix.arch == 'macos-arm64'
        uses: crystal-lang/install-crystal@v1

      - name: Install build dependencies (Linux)
        if: matrix.arch == 'linux-x86_64'
        run: apk add --no-cache cmake make g++ zlib-dev zlib-static libpng-dev libpng-static

      - name: Install build dependencies (macOS)
        if: matrix.arch == 'macos-arm64'
        run: brew install libharu

      - name: Build and install libharu (Linux)
        if: matrix.arch == 'linux-x86_64'
        run: |
          wget -q https://github.com/libharu/libharu/archive/refs/tags/v2.4.5.tar.gz
          tar xzf v2.4.5.tar.gz
          cmake -S libharu-2.4.5 -B libharu-build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_INSTALL_PREFIX=$HOME/.local
          cmake --build libharu-build --parallel
          cmake --install libharu-build

      - name: Install dependencies
        run: shards install --frozen

      - name: Build binary
        run: PKG_CONFIG_PATH=$HOME/.local/lib/pkgconfig shards build --release --no-debug ${{ matrix.build-flags }}

      - name: Smoke-test â€” generate example invoice
        run: ./bin/invoicegenerator --show-yml-example | ./bin/invoicegenerator --stdin --output invoice.pdf

      - name: Verify output is a valid PDF
        run: grep -qc "^%PDF" invoice.pdf

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: invoicegenerator-${{ matrix.arch }}
          path: bin/invoicegenerator
          if-no-files-found: error

  # Ameba linter
  lint:
    name: Ameba linter
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Ameba
        uses: crystal-ameba/github-action@v0.12.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # GitHub release (on version tags only)
  release:
    name: Create GitHub release
    needs: [build, lint]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: invoicegenerator-*
          merge-multiple: false

      - name: Compress binaries
        run: |
          chmod +x invoicegenerator-linux-x86_64/invoicegenerator
          chmod +x invoicegenerator-macos-arm64/invoicegenerator
          tar -czf invoicegenerator-linux-x86_64.tar.gz -C invoicegenerator-linux-x86_64 invoicegenerator
          tar -czf invoicegenerator-macos-arm64.tar.gz  -C invoicegenerator-macos-arm64  invoicegenerator

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            invoicegenerator-linux-x86_64.tar.gz
            invoicegenerator-macos-arm64.tar.gz
          generate_release_notes: true
